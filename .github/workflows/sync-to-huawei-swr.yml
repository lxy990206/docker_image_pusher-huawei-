name: Sync Images to Huawei SWR

on:
  push:
    paths: [ 'images.txt' ]
  workflow_dispatch:

jobs:
  sync-images:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Validate Secrets
      run: |
        # éªŒè¯æ‰€æœ‰å¿…éœ€çš„secretséƒ½å·²è®¾ç½®
        if [ -z "${{ secrets.HW_SWR_ORG_NAME }}" ]; then
          echo "âŒ é”™è¯¯: HW_SWR_ORG_NAME æœªè®¾ç½®ï¼è¯·é…ç½®ç»„ç»‡åç§°"
          exit 1
        fi
        if [ -z "${{ secrets.HW_SWR_REGION }}" ]; then
          echo "âŒ é”™è¯¯: HW_SWR_REGION æœªè®¾ç½®ï¼è¯·é…ç½®åŒºåŸŸ"
          exit 1
        fi
        echo "âœ… Secrets éªŒè¯é€šè¿‡"

    - name: Login to Huawei SWR
      run: |
        # ç¡®ä¿ç»„ç»‡åç§°å°å†™ä¸”æ— ç©ºæ ¼
        ORG_NAME=$(echo "${{ secrets.HW_SWR_ORG_NAME }}" | tr '[:upper:]' '[:lower:]' | tr -d ' ')
        
        echo "ä½¿ç”¨ç»„ç»‡: $ORG_NAME"
        echo "${{ secrets.HW_SWR_PASSWORD }}" | docker login \
          -u ${{ secrets.HW_SWR_USER }} \
          --password-stdin \
          swr.${{ secrets.HW_SWR_REGION }}.myhuaweicloud.com

    - name: Process Images
      run: |
        # è·å–å°å†™ç»„ç»‡åç§°å¹¶éªŒè¯
        ORG_NAME=$(echo "${{ secrets.HW_SWR_ORG_NAME }}" | tr '[:upper:]' '[:lower:]' | tr -d ' ')
        if [ -z "$ORG_NAME" ]; then
          echo "âŒ é”™è¯¯: ç»„ç»‡åç§°ä¸ºç©ºï¼"
          exit 1
        fi
        
        # éªŒè¯ç»„ç»‡åç§°æ ¼å¼
        if [[ ! "$ORG_NAME" =~ ^[a-z0-9_-]+$ ]]; then
          echo "âŒ é”™è¯¯: ç»„ç»‡åç§° '$ORG_NAME' åŒ…å«éæ³•å­—ç¬¦ï¼"
          echo "åä¸ºäº‘è¦æ±‚: å°å†™å­—æ¯ã€æ•°å­—ã€ä¸­åˆ’çº¿(-)æˆ–ä¸‹åˆ’çº¿(_)"
          exit 1
        fi
        
        echo "âœ… ä½¿ç”¨ç»„ç»‡åç§°: $ORG_NAME"
        echo "âœ… åŒºåŸŸ: ${{ secrets.HW_SWR_REGION }}"
        
        while IFS= read -r image; do
          # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Šè¡Œ
          [ -z "$image" ] && continue
          [[ "$image" == \#* ]] && continue
          
          echo "å¤„ç†é•œåƒ: $image"
          
          # æå–åŸå§‹é•œåƒåç§°å’Œæ ‡ç­¾
          if [[ "$image" == *":"* ]]; then
            image_name="${image%:*}"
            image_tag="${image#*:}"
          else
            image_name="$image"
            image_tag="latest"
          fi
          
          # æå–åŸºç¡€é•œåƒå (å»æ‰ä»“åº“åœ°å€)
          base_name=$(basename "$image_name")
          
          # è½¬æ¢ä¸ºå…¨å°å†™ (ç¬¦åˆåä¸ºäº‘è¦æ±‚)
          lowercase_name=$(echo "$base_name" | tr '[:upper:]' '[:lower:]')
          lowercase_tag=$(echo "$image_tag" | tr '[:upper:]' '[:lower:]')
          
          # æ„å»ºç›®æ ‡é•œåƒåœ°å€
          target_image="swr.${{ secrets.HW_SWR_REGION }}.myhuaweicloud.com/$ORG_NAME/$lowercase_name:$lowercase_tag"
          
          echo "ğŸ”§ è½¬æ¢: $image â†’ $target_image"
          
          # å®Œæ•´æ“ä½œæµç¨‹
          docker pull "$image"
          docker tag "$image" "$target_image"
          docker push "$target_image"
          docker rmi "$image" "$target_image" || true
          
          echo "âœ… æˆåŠŸæ¨é€: $target_image"
          echo "----------------------------------------"
        done < images.txt
